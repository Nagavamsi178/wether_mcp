name: Deploy Weather Agent to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Sync project to EC2
        run: |
          rsync -avz --delete \
            --exclude ".git" \
            --exclude ".github" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.REMOTE_APP_DIR }}

      - name: Create .env on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ secrets.REMOTE_APP_DIR }}

          cat > .env <<EOT
          OPENWEATHER_API_KEY=${{ secrets.OPENWEATHER_API_KEY }}
          OPENWEATHER_BASE_URL=http://api.openweathermap.org/data/2.5
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
          SERVER_URL=http://localhost:8000/mcp/sse
          EOT
          EOF

      - name: Install dependencies & restart services
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ secrets.REMOTE_APP_DIR }}

          python3 -m venv .venv || true
          source .venv/bin/activate

          pip install --upgrade pip
          pip install -r requirements.txt

          sudo systemctl restart weather-fastapi || true
          sudo systemctl restart weather-streamlit || true
          EOF
